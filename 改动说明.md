# 本次改动说明

本文档整理近期对分支定价/分支定界日志体系及数据快照输出的改动，帮助后续阅读代码和接入分析脚本。

## 总体思路
- 提供一个统一的日志初始化函数 `logging_utils.init_logging`，确保格式一致、子 logger 继承、避免重复 handler。
- 入口脚本与求解组件都改为依赖注入 logger，不再在各自模块硬编码文件名或格式。
- Label-setting 定价器与分支引擎只维护各自专属的文件 handler，保持向父级传播以共享 formatter/级别。
- 在 BP 求解结束时输出结构化 JSON/CSV 快照，字段覆盖迭代、节点、cut 数、卡车可行性等，方便离线分析。

## 日志基础设施
- `logging_utils.init_logging(outdir, name, level, to_console)` 会创建 `<outdir>/<name>.log` 文件，并可选同步到控制台；使用统一 formatter，固定包含时间、level、logger 名，以及 `node_id`/`iteration`/`phase` 三个上下文字段，缺失时由过滤器补全，避免 KeyError。【F:logging_utils.py†L5-L68】
- 只有在 logger 尚无 handler 时才创建文件/控制台 handler，防止重复添加；`propagate=True` 允许子 logger 复用同一套 handler 和格式。【F:logging_utils.py†L52-L68】

## Branch-and-Price 主流程
- `BPSolver` 在 `_init_logger` 中优先使用外部传入的 logger，并派生子 logger `bp`；若无则调用公共初始化在 `params.outdir` 下创建 `bp.log`，全部日志共享统一格式。【F:bp_drones.py†L1029-L1040】
- `LabelSettingGenerator` 会基于主 logger 构造 `"<base>.label"` 子 logger，仅在缺少同路径 handler 时挂载自己的 `label_setting.log` 文件，保持 `propagate=True` 以继承格式/级别，解决重复 handler 问题。【F:bp_drones.py†L148-L180】
- 每轮迭代记录的 `BPStatus` 现包含 cut 数与卡车可行性标志，日志打印时通过 `extra` 注入迭代、节点、阶段信息，便于格式化。【F:bp_drones.py†L960-L979】
- 求解结束调用 `_dump_snapshots`，将累积的 `BPStatus` 序列写入 `bp_snapshots.json` 与 `bp_snapshots.csv`，字段包括迭代号、节点、目标值、gap、列数、rc_min、dual 统计、cut_count、truck_feasible，并返回路径以便上层输出。【F:bp_drones.py†L985-L1016】

## 分支引擎
- `BranchEngine` 初始化时复用外部 logger 的子 logger `branch.engine`，否则在 `params.outdir` 下用 `init_logging` 创建 `branch.log`（默认无控制台输出）；日志级别与父级保持一致。【F:branch_and_bound.py†L96-L112】
- 仍在 `branch_decisions.csv` 中记录分支决策，文件路径由参数控制，创建时写入表头，便于后续分析。【F:branch_and_bound.py†L116-L121】

## 入口脚本与日志落盘位置
- `test_bp.py`、`test_lbbp.py`、`test_bnb.py` 均用 `init_logging(<outdir>, name="test_<module>")` 初始化最顶层 logger；各模块日志落在对应目录下的 `<name>.log`，并通过依赖注入传递给 `BPSolver`、`BranchEngine`、`LabelSettingGenerator` 等组件，无需单独设定文件名或格式。【F:test_bp.py†L35-L99】【F:test_lbbp.py†L46-L116】【F:test_bnb.py†L95-L189】
- BP 运行结束会输出最终解文件及快照路径，结合统一格式的日志，便于后续脚本汇总或可视化。

## 数据输出与后续分析
- BP 结构化快照的 JSON/CSV 路径可从 `BPResult.snapshot_paths` 获取，字段覆盖迭代、节点、列数量、cut 数、最小 rc、对偶统计与卡车可行性等，适合直接被分析脚本消费。【F:bp_drones.py†L589-L598】【F:bp_drones.py†L985-L1016】
- Label-setting 的候选路径仍按需追加到 `labels.csv`，配合主日志可追溯每轮生成的前 K 条路径及其 reduced cost。【F:bp_drones.py†L182-L200】

以上整理便于理解改动后的日志架构、调用方式及输出格式，便于继续迭代或接入外部分析工具。
